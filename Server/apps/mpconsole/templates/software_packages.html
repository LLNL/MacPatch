{% extends "base.html" %}

{% block styles %}
    {{ super() }}
    <link href="{{ url_for('static', filename='css/bootstrap-table.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='bootstrap-table/extensions/editable/bootstrap-editable.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/mp.css') }}" rel="stylesheet">
{%  endblock %}

{% block pageHeader %}
    Software Packages
{%  endblock %}

{% block bodyPanel %}

    <table id="table" class="table table-condensed" data-toolbar="#toolbar">
        <div id="toolbar">
            <button id="deleteButton" type="button" class="btn btn-default" title="Delete Package"><i class="glyphicon glyphicon-trash"></i></button>
            <button id="addButton" type="button" class="btn btn-default" title="New Package"><i class="glyphicon glyphicon-plus"></i></button>
            <button id="duplicateButton" type="button" class="btn btn-default" title="Duplicate Package"><i class="glyphicon glyphicon-duplicate"></i></button>
            <button id="taskButton" type="button" class="btn btn-default" title="Generate Task from Package"><i class="glyphicon glyphicon-cog"></i></button>
        </div>
    </table>

{% endblock %}


{% block javascript %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/bootstrap-table.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap-table/extensions/resizable/bootstrap-table-resizable.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap-table/extensions/editable/bootstrap-table-editable.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap-table/extensions/editable/bootstrap-editable.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap-table/colResizable-1.5.source.js') }}"></script>
    <script>

    function operateFormatter(value, row, index) 
    {
        var htmlData = [];
        htmlData.push('<table><tr><td>')
        htmlData.push('<a class="edit" href="javascript:void(0)" title="Edit Package">');
        htmlData.push('<i class="fa fa-pencil fa-lg" aria-hidden="true"></i>');
        htmlData.push('</a>');
        htmlData.push('</td><td>');
        htmlData.push('<a class="download" href="/mp-content' + row['sw_url'] + '" title="Download Package" target=_blank>');
        htmlData.push('<i class="fa fa-download fa-lg"></i></a>');
        htmlData.push('</td></tr></table>');
        return htmlData.join('');
    }

    window.operateEvents = {
        'click .edit': function (e, value, row, index)
        {
            $('#myContent').remove();
            $('#modaliFrame').remove();
            
            /* New Content */
            var _url = "/software/package/edit/" + row['suuid'];
            var innerHTML = '<iframe src="' + _url + '" id="modaliFrame"' +
            ' frameborder="0" allowtransparency="true"' +
            ' style="width: 98%; height: 98%; position: absolute"></iframe>';

            / * Show Modal Window */
            $('#modalTitle').html('Edit Software Package - ' + row['name']);
            $('#modalCancelButton').show();
            $('#modalSaveButton').hide();
            $('#modalBody').html(innerHTML);
            $('#modalDialog').addClass("modal-wide");
            $('#modalDialog').modal('show');
         
        }
    };

    var _cols = [{
                    field: 'state',
                    checkbox: true,
                    rowspan: 1,
                    align: 'center',
                    valign: 'middle'
                },
                    {
                    field: 'operate',
                    title: '',
                    align: 'center',
                    events: operateEvents,
                    formatter: operateFormatter
                },];

    _cols.push.apply(_cols, {{data["columns"] | tojson}});
    var _rows = {{data["rows"] | tojson}};

    $( document ).ready(function()
    {
            $('#table').bootstrapTable({

                striped: true,
                pagination: true,
                sidePagination: 'client',
                pageList: ['10', '20', '50', '100', 'All'],
                search: true,
                showRefresh: false,
                resizable: true,
                sortable: true,
                showColumns: false,
                icons: {
                    refresh: 'fa fa-refresh',
                    toggle: 'fa fa-th-list',
                    columns: 'fa fa-columns',
                    detailOpen: 'glyphicon glyphicon-info-sign',
                    detailClose: 'glyphicon glyphicon-minus-sign'
                },
                idField: 'suuid',
                columns: _cols,
                data: _rows
            });
    });

    var $table = $('#table'), $delBut = $('#deleteButton'), $addBut = $('#addButton'), $expBut = $('#exportButton'), $impBut = $('#importButton');
    $(function () {
        $delBut.click(function ()
        {

            var ids = $.map($table.bootstrapTable('getSelections'), function (row) {
                return row.suuid;
            });
            var name = $.map($table.bootstrapTable('getSelections'), function (row) {
                return row.sName;
            });

            if (confirm('Are you sure to delete (' + name +') ?'))
            {
                $.get( "/software/package/delete/" + ids).done(function(data)
                {
                    console.log(data);
                    console.log(data.error);
                    var result = JSON.parse(data);

                    if (result.error == 0) {
                        $('#table').bootstrapTable('remove', {
                            field: 'suuid',
                            values: ids
                        });
                    } else {
                        $('#myContent').remove();
                        $('#modaliFrame').remove();
                        $('#modalDialog').removeClass("modal-wide");
                        
                        $('#modalSaveButton').hide();
                        $('#modalCancelButton').html('Close');
                        $('#modalTitle').html('Error, Removing Software Package');
                        $('#modalBody').html('Delete item error!');
                        $('#modalBody').css({'height':'200px'});
                        $('#modalHeader').addClass('panel-heading');
                        $('#modalContent').addClass('panel-danger');
                        $('#modalDialog').modal('show');
                    }
                });
            }

            /*
            var ids = $.map($table.bootstrapTable('getSelections'), function (row) {
                return row.tuuid;
            });
            $table.bootstrapTable('remove', {
                field: 'tuuid',
                values: ids
            });
            */
        });

        $addBut.click(function ()
        {
            $('#myContent').remove();
            $('#modaliFrame').remove();
            
            /* New Content */
            var _url = "/software/package/add";
            var innerHTML = '<iframe src="' + _url + '" id="modaliFrame"' +
            ' frameborder="0" allowtransparency="true"' +
            ' style="width: 98%; height: 98%; position: absolute"></iframe>';

            / * Show Modal Window */
            $('#modalTitle').html('New Software Package');
            $('#modalCancelButton').show();
            $('#modalBody').html(innerHTML);
            $('#modalDialog').addClass("modal-wide");
            $('#modalDialog').modal('show');
        });

        $expBut.click(function ()
        {
            alert("Export Called, not done!");
        });

        $impBut.click(function ()
        {
            alert("Import Called, not done!");
        });
    });
    
    function closeModal() {
        $("#modalDialog").modal("hide");
    }
    </script>
{% endblock %}