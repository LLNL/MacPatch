{% extends "base.html" %}

{% block styles %}
    {{ super() }}
    <link href="{{ url_for('static', filename='css/bootstrap-table.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/mp.css') }}" rel="stylesheet">

{%  endblock %}

{% block pageHeader %}
    Custom Patches
{%  endblock %}

{% block bodyPanel %}

    <table id="table" data-toolbar="#toolbar" class="table table-condensed" data-show-export="true">
        <div id="toolbar">
            <button id="addButton" type="button" class="btn btn-default"><i class="glyphicon glyphicon-plus"></i></button>
            <button id="delButton" type="button" class="btn btn-default"><i class="glyphicon glyphicon-trash"></i></button>
        </div>
    </table>

{% endblock %}


{% block javascript %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/bootstrap-table.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap-table/extensions/resizable/bootstrap-table-resizable.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap-table/colResizable-1.5.source.js') }}"></script>
    <link href="{{ url_for('static', filename='css/mp.css') }}" rel="stylesheet">
    <script>
    $( document ).ready(function()
    {
            $('#table').bootstrapTable({

                striped: true,
                pagination: true,
                sidePagination: 'client',
                pageList: ['10', '25', '50', '100', 'All'],
                search: true,
                showRefresh: true,
                resizable: true,
                sortable: true,
                showColumns: false,
                detailView: false,
                detailFormatter: detailFormatter,
                icons: {
                    refresh: 'fa fa-refresh',
                    toggle: 'fa fa-th-list',
                    columns: 'fa fa-columns',
                    detailOpen: 'glyphicon glyphicon-info-sign',
                    detailClose: 'glyphicon glyphicon-minus-sign'
                },
                idField: 'puuid',

                columns: [
                {
                        field: 'state',
                        checkbox: true,
                        rowspan: 1,
                        align: 'center',
                        valign: 'middle'
                },
                {
                    field: 'operate',
                    title: '',
                    align: 'center',
                    events: operateEvents,
                    formatter: operateFormatter
                },
                {% for col in columnsAll %}

                    {% if col.name in columns %}
                        {% if col.name != 'description' %}
                        {
                            field: '{{col.name}}',
                            title: '{{col.info}}',
                            {% if col.name ==  'puuid' or col.name == 'pkg_path' or col.name == 'pkg_url' or col.name == 'description'%}
                            visible: false,
                            {% endif %}
                            sortable: true
                         },
                        {% endif %}
                    {% endif %}

                {% endfor %}
                ],
                data: [
                {% for patch in data %}
                {
                    {% for col in columns %}
                        {% if col != 'description'%}
                            {{col}}: '{{patch[col]}}',
                        {% endif %}
                    {% endfor %}
                },
                {% endfor %}
                ]
            });
    });

    function detailFormatter(index, row) {
        var html = [];
        var re = /\\n/g;
        var re2 = /\\t/g;
        var re3 = /<style([\S\s]*?)>([\S\s]*?)<\/style>/ig;
        var decodedData = window.atob(row['description64']);
        var description = decodedData.replace("Data('"," ");
        description = description.replace("')"," ");
        description = description.replace(re," ");
        description = description.replace(re2," ");
        description = description.replace(re3," ");
        if (description.trim() == "") {
            description = '<p>No Description</p>'
        }
        html.push(description);
        return html.join('');
    }

    var $table = $('#table'), $delButton = $('#delButton'), $addButton = $('#addButton');
    $(function () {
        $delButton.click(function ()
        {
            var ids = $.map($table.bootstrapTable('getSelections'), function (row) {

                return row.puuid;
            });
            $table.bootstrapTable('remove', {
                field: 'puuid',
                values: ids
            });
        });

        $addButton.click(function ()
        {
            var _url = "/patches/customPatchWizardAdd";
            var innerHTML = '<iframe src="' + _url + '" id="modaliFrame"' +
             ' frameborder="0" allowtransparency="true"' +
             ' style="width: 98%; height: 98%; position: absolute"></iframe>';

            $('#modalTitle').html("New Custom Patch");
            $('#modalCloseButton').html('Cancel');
            $('#modalBody').html(innerHTML);
            $('#modalBody').css({'height':'770px'});
            $('#modalDialog').addClass("modal-wide");
            $('#modalDialog').modal('show');
        });
    });



    function operateFormatter(value, row, index) {
        return [
            '<a class="edit" href="javascript:void(0)" title="Edit">',
            '<i class="fa fa-pencil fa-lg" aria-hidden="true"></i>',
            '</a>&nbsp;'
        ].join('');
    }

    window.operateEvents = {
        'click .edit': function (e, value, row, index)
        {
            $.get( "/patches/customPatchWizard/" + row['puuid']).done(function(data) {
                $('#modalBody').html(data);
                $('#modalSaveButton').hide();
                $('#modalDialog').addClass("modal-wide");
                $('#modalBody').css({'height':'770px'});
                $('#modalDialog').modal('show');
            });
        },
        'click .description': function (e, value, row, index) {
            alert('You click description action, row: ' + JSON.stringify(row));
        }
    };
    </script>
{% endblock %}